<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA4 ì‹¤ì „ ì—°ë™ ì²´í—˜ê´€ | KT nasmedia GA4 & GTM ê°€ì´ë“œ ì„¼í„°</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/home.css">
</head>
<body class="has-sidebar">
    <div id="header"></div>
    <div id="sidebar"></div>
    <main class="main-content">

<!-- ì‹¤ì œ ë°ì´í„°ë¡œ ë°°ìš°ê¸° ì„¹ì…˜ -->
<section class="real-data-section">
    <div class="real-data-content">
        <h2 class="real-data-title">ì‹¤ì œ ë°ì´í„°ë¡œ ë°°ìš°ê¸°</h2>
        <p class="real-data-subtitle">êµ¬ê¸€ OAuthë¥¼ í†µí•´ ì‹¤ì œ GA4 ë°ì´í„°ì— ì ‘ê·¼í•˜ì—¬<br>ì‹¤ë¬´ì—ì„œ ë°”ë¡œ í™œìš©í•  ìˆ˜ ìˆëŠ” ë¶„ì„ ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤</p>
        
        <div class="oauth-features">
            <div class="feature-card">
                <div class="feature-icon">ğŸ”</div>
                <div class="feature-title">ì•ˆì „í•œ OAuth ì¸ì¦</div>
                <div class="feature-description">êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ë¡œê·¸ì¸í•˜ì—¬ GA4 ë°ì´í„°ì— ì ‘ê·¼</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ“Š</div>
                <div class="feature-title">ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ</div>
                <div class="feature-description">ì‹¤ì œ GA4 ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì‹¤ì‹œê°„ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ“ˆ</div>
                <div class="feature-title">ì¸í„°ë™í‹°ë¸Œ ì°¨íŠ¸</div>
                <div class="feature-description">ì‚¬ìš©ì, ì„¸ì…˜, ë””ë°”ì´ìŠ¤ë³„ ë°ì´í„°ë¥¼ ì‹œê°í™”í•œ ì°¨íŠ¸</div>
            </div>
        </div>
    </div>
</section>

<!-- GA4 ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ -->
<section id="ga4-dashboard-section" class="ga4-dashboard-section">
    <div class="ga4-container">
        <div class="ga4-header">
            <h2>ğŸš€ GA4 Analytics Dashboard</h2>
            <p>êµ¬ê¸€ ì• ë„ë¦¬í‹±ìŠ¤ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <!-- API ë¡œë“œ ìƒíƒœ -->
        <div class="ga4-status-indicator" id="apiStatus">
            API ë¡œë”© ì¤‘... â³
        </div>

        <!-- ì¸ì¦ ì„¹ì…˜ -->
        <div class="ga4-auth-section" id="authSection">
            <h3>ì‹œì‘í•˜ê¸°</h3>
            <p>êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì—¬ GA4 ë°ì´í„°ì— ì ‘ê·¼í•˜ì„¸ìš”</p>
            <button class="ga4-google-login-btn" id="googleLoginBtn" onclick="handleGoogleLogin()" disabled>
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span id="loginBtnText">API ë¡œë”© ì¤‘...</span>
            </button>
            <div class="ga4-error-message" id="errorMessage"></div>
        </div>

        <!-- ì‚¬ìš©ì ì •ë³´ ë° ê³„ì • ì„ íƒ -->
        <div class="ga4-user-info" id="userInfo">
            <img class="ga4-user-avatar" id="userAvatar" src="" alt="ì‚¬ìš©ì">
            <div style="flex: 1;">
                <div class="ga4-user-name" id="userName"></div>
                <div class="ga4-user-email" id="userEmail"></div>
            </div>
            <button class="ga4-logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="ga4-account-selector" id="accountSelector">
            <h3>GA4 ê³„ì • ë° ì†ì„± ì„ íƒ</h3>
            
            <div class="ga4-selector-group">
                <label for="accountSelect">ê³„ì • ì„ íƒ:</label>
                <select id="accountSelect" onchange="loadProperties()">
                    <option value="">ê³„ì •ì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>

            <div class="ga4-selector-group">
                <label for="propertySelect">ì†ì„± ì„ íƒ:</label>
                <select id="propertySelect" onchange="enableReportButton()">
                    <option value="">ë¨¼ì € ê³„ì •ì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>

            <!-- ë‚ ì§œ ë²”ìœ„ ì„ íƒ -->
            <div class="ga4-date-range-selector">
                <h4>ğŸ“… ë¶„ì„ ê¸°ê°„ ì„ íƒ</h4>
                <div class="ga4-date-inputs">
                    <div class="ga4-date-input-group">
                        <label for="startDate">ì‹œì‘ì¼:</label>
                        <input type="date" id="startDate" onchange="updateDateRange()">
                    </div>
                    <div class="ga4-date-input-group">
                        <label for="endDate">ì¢…ë£Œì¼:</label>
                        <input type="date" id="endDate" onchange="updateDateRange()">
                    </div>
                </div>
                <div class="ga4-quick-date-buttons">
                    <button class="ga4-quick-date-btn" onclick="setQuickDateRange('7days')">ìµœê·¼ 7ì¼</button>
                    <button class="ga4-quick-date-btn" onclick="setQuickDateRange('30days')">ìµœê·¼ 30ì¼</button>
                    <button class="ga4-quick-date-btn" onclick="setQuickDateRange('90days')">ìµœê·¼ 90ì¼</button>
                </div>
            </div>

            <button class="ga4-load-report-btn" id="loadReportBtn" onclick="loadReport()" disabled>
                ğŸ“Š ë¦¬í¬íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
            </button>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ -->
        <div class="ga4-dashboard" id="dashboard">
            <div class="ga4-loading" id="loading">ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
            
            <div id="reportContent" style="display: none;">
                <div class="ga4-dashboard-header">
                    <h3>ğŸ“ˆ GA4 ë¦¬í¬íŠ¸ ëŒ€ì‹œë³´ë“œ</h3>
                    <div class="ga4-last-updated" id="lastUpdated">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</div>
                </div>
                
                <!-- ì£¼ìš” ì§€í‘œ ì¹´ë“œ -->
                <div class="ga4-metrics-grid">
                    <div class="ga4-metric-card">
                        <div class="ga4-metric-icon">ğŸ‘¥</div>
                        <div class="ga4-metric-content">
                            <h4>ì´ ì‚¬ìš©ì</h4>
                            <div class="ga4-metric-value" id="totalUsers">-</div>
                            <div class="ga4-metric-change" id="totalUsersChange">-</div>
                        </div>
                    </div>
                    <div class="ga4-metric-card">
                        <div class="ga4-metric-icon">ğŸ†•</div>
                        <div class="ga4-metric-content">
                            <h4>ì‹ ê·œ ì‚¬ìš©ì</h4>
                            <div class="ga4-metric-value" id="newUsers">-</div>
                            <div class="ga4-metric-change" id="newUsersChange">-</div>
                        </div>
                    </div>
                    <div class="ga4-metric-card">
                        <div class="ga4-metric-icon">ğŸ“Š</div>
                        <div class="ga4-metric-content">
                            <h4>ì„¸ì…˜ìˆ˜</h4>
                            <div class="ga4-metric-value" id="sessions">-</div>
                            <div class="ga4-metric-change" id="sessionsChange">-</div>
                        </div>
                    </div>
                    <div class="ga4-metric-card">
                        <div class="ga4-metric-icon">ğŸ“„</div>
                        <div class="ga4-metric-content">
                            <h4>ì¡°íšŒìˆ˜</h4>
                            <div class="ga4-metric-value" id="screenPageViews">-</div>
                            <div class="ga4-metric-change" id="screenPageViewsChange">-</div>
                        </div>
                    </div>
                    <div class="ga4-metric-card">
                        <div class="ga4-metric-icon">âš ï¸</div>
                        <div class="ga4-metric-content">
                            <h4>ì´íƒˆë¥ </h4>
                            <div class="ga4-metric-value" id="bounceRate">-</div>
                            <div class="ga4-metric-change" id="bounceRateChange">-</div>
                        </div>
                    </div>
                    <div class="ga4-metric-card">
                        <div class="ga4-metric-icon">ğŸ“„</div>
                        <div class="ga4-metric-content">
                            <h4>ì„¸ì…˜ë‹¹ í˜ì´ì§€ë·°</h4>
                            <div class="ga4-metric-value" id="screenPageViewsPerSession">-</div>
                            <div class="ga4-metric-change" id="screenPageViewsPerSessionChange">-</div>
                        </div>
                    </div>
                    <div class="ga4-metric-card">
                        <div class="ga4-metric-icon">â±ï¸</div>
                        <div class="ga4-metric-content">
                            <h4>í‰ê·  ì„¸ì…˜ ì‹œê°„</h4>
                            <div class="ga4-metric-value" id="averageSessionDuration">-</div>
                            <div class="ga4-metric-change" id="averageSessionDurationChange">-</div>
                        </div>
                    </div>
                </div>

                <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
                <div class="ga4-chart-container">
                    <h4>ğŸ“… ì¼ë³„ ì‚¬ìš©ì ë° ì„¸ì…˜ ì¶”ì´</h4>
                    <div class="ga4-chart-wrapper">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- ë””ë°”ì´ìŠ¤ ë° ë¸Œë¼ìš°ì € ë¶„ì„ ì„¹ì…˜ -->
                <div class="ga4-analysis-row">
                    <div class="ga4-chart-container ga4-chart-half">
                        <h4>ğŸ“± ë””ë°”ì´ìŠ¤ë³„ ë¶„ì„</h4>
                        <div class="ga4-chart-wrapper">
                            <canvas id="deviceChart"></canvas>
                        </div>
                    </div>
                    <div class="ga4-chart-container ga4-chart-half">
                        <h4>ğŸŒ ë¸Œë¼ìš°ì € ë¶„ì„</h4>
                        <div class="ga4-table-wrapper">
                            <table class="ga4-browser-table" id="browserTable">
                                <thead>
                                    <tr>
                                        <th>ìˆœìœ„</th>
                                        <th>ë¸Œë¼ìš°ì €</th>
                                        <th>ì„¸ì…˜</th>
                                        <th>ì ìœ ìœ¨</th>
                                    </tr>
                                </thead>
                                <tbody id="browserTableBody">
                                    <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ìœ ì… ì±„ë„ ë¶„ì„ -->
                <div class="ga4-chart-container">
                    <h4>ğŸŒ ìœ ì… ì±„ë„ ë¶„ì„</h4>
                    <div class="ga4-chart-wrapper">
                        <canvas id="channelChart"></canvas>
                    </div>
                </div>

                <!-- ì£¼ìš” ì´ë²¤íŠ¸ ë¶„ì„ -->
                <div class="ga4-chart-container">
                    <h4>ğŸ¯ ì£¼ìš” ì´ë²¤íŠ¸ ë¶„ì„</h4>
                    <div class="ga4-table-wrapper">
                        <table class="ga4-event-table" id="eventTable">
                                <thead>
                                    <tr>
                                        <th>ìˆœìœ„</th>
                                        <th>ì´ë²¤íŠ¸ëª…</th>
                                        <th>ë°œìƒíšŸìˆ˜</th>
                                        <th>ë¹„ê³ </th>
                                    </tr>
                                </thead>
                            <tbody id="eventTableBody">
                                <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ì¸ê¸° í˜ì´ì§€ TOP 10 -->
                <div class="ga4-chart-container">
                    <h4>ğŸ”¥ ì¸ê¸° í˜ì´ì§€ TOP 10</h4>
                    <div class="ga4-table-wrapper">
                        <table class="ga4-top-pages-table" id="topPagesTable">
                            <thead>
                                <tr>
                                    <th>ìˆœìœ„</th>
                                    <th>í˜ì´ì§€ ê²½ë¡œ</th>
                                    <th>í˜ì´ì§€ë·°</th>
                                    <th>ë¹„ìœ¨</th>
                                </tr>
                            </thead>
                            <tbody id="topPagesTableBody">
                                <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ì§€ì—­ë³„ ì‚¬ìš©ì ë¶„í¬ -->
                <div class="ga4-chart-container">
                    <h4>ğŸŒ ì§€ì—­ë³„ ì‚¬ìš©ì ë¶„í¬</h4>
                    <div class="ga4-table-wrapper">
                        <table class="ga4-geo-table" id="geoTable">
                            <thead>
                                <tr>
                                    <th>ìˆœìœ„</th>
                                    <th>êµ­ê°€</th>
                                    <th>ì‚¬ìš©ì ìˆ˜</th>
                                    <th>ë¹„ìœ¨</th>
                                </tr>
                            </thead>
                            <tbody id="geoTableBody">
                                <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ì¢…í•© ë¶„ì„ ë° ê¶Œì¥ì‚¬í•­ -->
                <div class="ga4-insights-container">
                    <h4>ğŸ’¡ ì¢…í•© ë¶„ì„ ë° ê¶Œì¥ì‚¬í•­</h4>
                    <div class="ga4-insights-content" id="insightsContent">
                        <div class="ga4-insight-section">
                            <h5>ğŸ“ˆ ê°•ì </h5>
                            <ul id="strengthsList">
                                <li>ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</li>
                            </ul>
                        </div>
                        <div class="ga4-insight-section">
                            <h5>âš ï¸ ê°œì„  í•„ìš” ì˜ì—­</h5>
                            <ul id="improvementsList">
                                <li>ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</li>
                            </ul>
                        </div>
                        <div class="ga4-insight-section">
                            <h5>ğŸ’¡ ì‹¤í–‰ ê¶Œì¥ì‚¬í•­</h5>
                            <ul id="recommendationsList">
                                <li>ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- GA4 Dashboard JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
// GA4 Dashboard JavaScript
(function() {
    // ì „ì—­ ë³€ìˆ˜
    let gapi_loaded = false;
    let gsi_loaded = false;
    let accessToken = null;
    let selectedPropertyId = null;
    let currentUser = null;
    let currentDateRange = {
        startDate: '7daysAgo',
        endDate: 'today'
    };
    let previousPeriodData = null;
    
    // ê³ ì •ëœ Client ID
    const CLIENT_ID = '655746397306-gtbrlf06a89uqd0sm01lj2lg8ecvfpmp.apps.googleusercontent.com';
    const SCOPES = 'openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/analytics.readonly';

    // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateStatus(message, isSuccess = false) {
        const statusEl = document.getElementById('apiStatus');
        if (statusEl) {
            statusEl.textContent = message;
            if (isSuccess) {
                statusEl.style.background = '#d4edda';
                statusEl.style.borderColor = '#c3e6cb';
                statusEl.style.color = '#155724';
            }
        }
    }

    // ë‚ ì§œ ë²”ìœ„ ì„¤ì • í•¨ìˆ˜ë“¤
    window.setQuickDateRange = function(period) {
        const today = new Date();
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        let days;
        switch(period) {
            case '7days':
                days = 7;
                break;
            case '30days':
                days = 30;
                break;
            case '90days':
                days = 90;
                break;
            default:
                days = 7;
        }
        
        const startDate = new Date(today);
        startDate.setDate(today.getDate() - days);
        
        if (startDateInput) startDateInput.value = startDate.toISOString().split('T')[0];
        if (endDateInput) endDateInput.value = today.toISOString().split('T')[0];
        
        updateDateRange();
    };

    window.updateDateRange = function() {
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        if (startDateInput && endDateInput && startDateInput.value && endDateInput.value) {
            currentDateRange.startDate = startDateInput.value;
            currentDateRange.endDate = endDateInput.value;
        }
    };

    // ì´ˆê¸° ë‚ ì§œ ì„¤ì •
    function initializeDateRange() {
        setQuickDateRange('7days');
    }

    // Google API ë¡œë“œ í•¨ìˆ˜ë“¤
    window.ga4GapiLoaded = function() {
        console.log('Google API ë¡œë“œ ì™„ë£Œ');
        gapi_loaded = true;
        updateStatus('Google API ë¡œë“œ ì™„ë£Œ âœ…');
        checkAllApisLoaded();
    };

    window.ga4GsiLoaded = function() {
        console.log('Google Sign-In ë¡œë“œ ì™„ë£Œ');
        gsi_loaded = true;
        updateStatus('Google Sign-In ë¡œë“œ ì™„ë£Œ âœ…');
        checkAllApisLoaded();
    };

    function checkAllApisLoaded() {
        if (gapi_loaded && gsi_loaded) {
            updateStatus('ëª¨ë“  API ë¡œë“œ ì™„ë£Œ! Googleë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš” ğŸ‰', true);
            const loginBtn = document.getElementById('googleLoginBtn');
            const loginText = document.getElementById('loginBtnText');
            if (loginBtn && loginText) {
                loginBtn.disabled = false;
                loginText.textContent = 'Googleë¡œ ë¡œê·¸ì¸';
            }
        }
    }

    // êµ¬ê¸€ ë¡œê·¸ì¸ ì²˜ë¦¬
    window.handleGoogleLogin = function() {
        if (!gsi_loaded) {
            showError('Google Sign-Inì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            console.log('OAuth ì´ˆê¸°í™” ì‹œë„...');
            
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: handleAuthResponse,
                error_callback: (error) => {
                    console.error('OAuth Error:', error);
                    showError(`ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.type || error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            });
            
            console.log('í† í° ìš”ì²­...');
            client.requestAccessToken({
                prompt: 'consent',
            });
            
        } catch (error) {
            showError('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            console.error('Login error:', error);
        }
    };

    // ì¸ì¦ ì‘ë‹µ ì²˜ë¦¬
    function handleAuthResponse(response) {
        console.log('Auth response:', response);
        
        if (response.error) {
            showError('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + response.error);
            return;
        }

        accessToken = response.access_token;
        console.log('ì•¡ì„¸ìŠ¤ í† í° íšë“ ì™„ë£Œ');
        
        getUserInfo();
    }

    // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    async function getUserInfo() {
        try {
            console.log('ì‚¬ìš©ì ì •ë³´ ìš”ì²­...');
            const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });
            
            const userInfo = await response.json();
            console.log('ì‚¬ìš©ì ì •ë³´:', userInfo);
            
            if (response.ok) {
                displayUserInfo(userInfo);
                loadAccounts();
                
                // UI ìƒíƒœ ë³€ê²½
                const authSection = document.getElementById('authSection');
                const accountSelector = document.getElementById('accountSelector');
                if (authSection) authSection.style.display = 'none';
                if (accountSelector) accountSelector.style.display = 'block';
            } else {
                throw new Error('ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨');
            }
        } catch (error) {
            console.error('User info error:', error);
            showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }

    // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
    function displayUserInfo(userInfo) {
        currentUser = userInfo;
        
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userInfo_div = document.getElementById('userInfo');
        
        if (userAvatar) userAvatar.src = userInfo.picture || '';
        if (userName) userName.textContent = userInfo.name || 'ì‚¬ìš©ì';
        if (userEmail) userEmail.textContent = userInfo.email || '';
        if (userInfo_div) userInfo_div.style.display = 'flex';
    }

    // GA4 ê³„ì • ëª©ë¡ ë¡œë“œ
    async function loadAccounts() {
        try {
            console.log('GA4 ê³„ì • ëª©ë¡ ìš”ì²­...');
            const response = await fetch('https://analyticsadmin.googleapis.com/v1beta/accounts', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });
            
            const data = await response.json();
            console.log('ê³„ì • ë°ì´í„°:', data);
            
            if (response.ok && data.accounts) {
                populateAccountSelect(data.accounts);
            } else {
                throw new Error(data.error?.message || 'GA4 ê³„ì • ë¡œë“œ ì‹¤íŒ¨');
            }
        } catch (error) {
            console.error('Load accounts error:', error);
            showError('GA4 ê³„ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }

    // ê³„ì • ì„ íƒ ë°•ìŠ¤ ì±„ìš°ê¸°
    function populateAccountSelect(accounts) {
        const accountSelect = document.getElementById('accountSelect');
        if (!accountSelect) return;
        
        accountSelect.innerHTML = '<option value="">ê³„ì •ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        
        accounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account.name;
            option.textContent = account.displayName || account.name;
            accountSelect.appendChild(option);
        });
        
        console.log(`${accounts.length}ê°œ ê³„ì • ë¡œë“œë¨`);
    }

    // ì†ì„± ëª©ë¡ ë¡œë“œ
    window.loadProperties = async function() {
        const accountResourceName = document.getElementById('accountSelect').value;
        const propertySelect = document.getElementById('propertySelect');
        const loadReportBtn = document.getElementById('loadReportBtn');
        
        if (propertySelect) {
            propertySelect.innerHTML = '<option value="">ì†ì„±ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        }
        if (loadReportBtn) {
            loadReportBtn.disabled = true;
        }
        
        if (!accountResourceName) return;
        
        try {
            console.log('ì†ì„± ëª©ë¡ ìš”ì²­:', accountResourceName);
            const encodedFilter = encodeURIComponent(`parent:${accountResourceName}`);
            const url = `https://analyticsadmin.googleapis.com/v1beta/properties?filter=${encodedFilter}&pageSize=200`;
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });
            
            const data = await response.json();
            console.log('ì†ì„± ë°ì´í„°:', data);
            
            if (response.ok && data.properties) {
                data.properties.forEach(property => {
                    const option = document.createElement('option');
                    option.value = property.name.split('/')[1];
                    option.textContent = property.displayName || property.name;
                    if (propertySelect) propertySelect.appendChild(option);
                });
                console.log(`${data.properties.length}ê°œ ì†ì„± ë¡œë“œë¨`);
            } else {
                throw new Error(data.error?.message || 'ì†ì„± ë¡œë“œ ì‹¤íŒ¨');
            }
        } catch (error) {
            console.error('Load properties error:', error);
            showError('GA4 ì†ì„±ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    };

    // ë¦¬í¬íŠ¸ ë²„íŠ¼ í™œì„±í™”
    window.enableReportButton = function() {
        const propertySelect = document.getElementById('propertySelect');
        const loadReportBtn = document.getElementById('loadReportBtn');
        
        if (propertySelect && loadReportBtn) {
            const propertyId = propertySelect.value;
            loadReportBtn.disabled = !propertyId;
            selectedPropertyId = propertyId;
            console.log('ì„ íƒëœ ì†ì„± ID:', selectedPropertyId);
        }
    };

    // ë¦¬í¬íŠ¸ ë¡œë“œ
    window.loadReport = async function() {
        if (!selectedPropertyId) return;
        
        console.log('ë¦¬í¬íŠ¸ ë¡œë“œ ì‹œì‘:', selectedPropertyId);
        const dashboard = document.getElementById('dashboard');
        const loading = document.getElementById('loading');
        const reportContent = document.getElementById('reportContent');
        
        if (dashboard) dashboard.style.display = 'block';
        if (loading) loading.style.display = 'block';
        if (reportContent) reportContent.style.display = 'none';
        
        // ìŠ¤í¬ë¡¤ì„ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
        if (dashboard) {
            dashboard.scrollIntoView({ behavior: 'smooth' });
        }
        
        try {
            await fetchGA4Data();
            
            if (loading) loading.style.display = 'none';
            if (reportContent) reportContent.style.display = 'block';
        } catch (error) {
            console.error('ë¦¬í¬íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
            if (loading) loading.style.display = 'none';
            showError('ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    };

    // GA4 ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function fetchGA4Data() {
        console.log('GA4 ë°ì´í„° ìš”ì²­ ì‹œì‘...', currentDateRange);
        
        try {
            // ì´ì „ ê¸°ê°„ ë°ì´í„° ê³„ì‚° (ë¹„êµìš©)
            const previousPeriod = calculatePreviousPeriod();
            
            // ê¸°ë³¸ ì§€í‘œ ë°ì´í„° ìš”ì²­
            const metricsResponse = await fetch(`https://analyticsdata.googleapis.com/v1beta/properties/${selectedPropertyId}:runReport`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dateRanges: [{
                        startDate: currentDateRange.startDate,
                        endDate: currentDateRange.endDate
                    }],
                    metrics: [
                        { name: 'totalUsers' },
                        { name: 'newUsers' },
                        { name: 'sessions' },
                        { name: 'engagedSessions' },
                        { name: 'engagementRate' },
                        { name: 'bounceRate' },
                        { name: 'screenPageViews' },
                        { name: 'averageSessionDuration' }
                    ]
                })
            });
            
            const metricsData = await metricsResponse.json();
            
            if (!metricsResponse.ok) {
                throw new Error(metricsData.error?.message || 'ì§€í‘œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
            
            // ì´ì „ ê¸°ê°„ ë°ì´í„° ìš”ì²­ (ë¹„êµìš©)
            const previousMetricsResponse = await fetch(`https://analyticsdata.googleapis.com/v1beta/properties/${selectedPropertyId}:runReport`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dateRanges: [{
                        startDate: previousPeriod.startDate,
                        endDate: previousPeriod.endDate
                    }],
                    metrics: [
                        { name: 'totalUsers' },
                        { name: 'newUsers' },
                        { name: 'sessions' },
                        { name: 'engagedSessions' },
                        { name: 'engagementRate' },
                        { name: 'bounceRate' },
                        { name: 'screenPageViews' },
                        { name: 'averageSessionDuration' }
                    ]
                })
            });
            
            const previousMetricsData = await previousMetricsResponse.json();
            
            // ì¼ë³„ ì¶”ì´ ë°ì´í„° ìš”ì²­
            const trendResponse = await fetch(`https://analyticsdata.googleapis.com/v1beta/properties/${selectedPropertyId}:runReport`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dateRanges: [{
                        startDate: currentDateRange.startDate,
                        endDate: currentDateRange.endDate
                    }],
                    dimensions: [{ name: 'date' }],
                    metrics: [
                        { name: 'totalUsers' },
                        { name: 'sessions' }
                    ]
                })
            });
            
            const trendData = await trendResponse.json();
            
            if (!trendResponse.ok) {
                throw new Error(trendData.error?.message || 'ì¶”ì´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
            
            // ë””ë°”ì´ìŠ¤ë³„ ë°ì´í„° ìš”ì²­
            const deviceResponse = await fetch(`https://analyticsdata.googleapis.com/v1beta/properties/${selectedPropertyId}:runReport`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dateRanges: [{
                        startDate: currentDateRange.startDate,
                        endDate: currentDateRange.endDate
                    }],
                    dimensions: [{ name: 'deviceCategory' }],
                    metrics: [{ name: 'totalUsers' }, { name: 'sessions' }]
                })
            });
            
            const deviceData = await deviceResponse.json();
            
            if (!deviceResponse.ok) {
                throw new Error(deviceData.error?.message || 'ë””ë°”ì´ìŠ¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
            
            // ë¸Œë¼ìš°ì €ë³„ ë°ì´í„° ìš”ì²­
            const browserResponse = await fetch(`https://analyticsdata.googleapis.com/v1beta/properties/${selectedPropertyId}:runReport`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dateRanges: [{
                        startDate: currentDateRange.startDate,
                        endDate: currentDateRange.endDate
                    }],
                    dimensions: [{ name: 'browser' }],
                    metrics: [{ name: 'totalUsers' }, { name: 'sessions' }],
                    orderBys: [{ metric: { metricName: 'totalUsers' }, desc: true }],
                    limit: 10
                })
            });
            
            const browserData = await browserResponse.json();
            
            if (!browserResponse.ok) {
                throw new Error(browserData.error?.message || 'ë¸Œë¼ìš°ì € ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
            
            // ìœ ì… ì±„ë„ ë°ì´í„° ìš”ì²­
            const channelResponse = await fetch(`https://analyticsdata.googleapis.com/v1beta/properties/${selectedPropertyId}:runReport`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dateRanges: [{
                        startDate: currentDateRange.startDate,
                        endDate: currentDateRange.endDate
                    }],
                    dimensions: [{ name: 'sessionDefaultChannelGroup' }],
                    metrics: [{ name: 'sessions' }, { name: 'totalUsers' }],
                    orderBys: [{ metric: { metricName: 'sessions' }, desc: true }],
                    limit: 10
                })
            });
            
            const channelData = await channelResponse.json();
            
            if (!channelResponse.ok) {
                throw new Error(channelData.error?.message || 'ì±„ë„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
            
            // ì£¼ìš” ì´ë²¤íŠ¸ ë°ì´í„° ìš”ì²­
            const eventResponse = await fetch(`https://analyticsdata.googleapis.com/v1beta/properties/${selectedPropertyId}:runReport`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dateRanges: [{
                        startDate: currentDateRange.startDate,
                        endDate: currentDateRange.endDate
                    }],
                    dimensions: [{ name: 'eventName' }],
                    metrics: [{ name: 'eventCount' }],
                    orderBys: [{ metric: { metricName: 'eventCount' }, desc: true }],
                    limit: 10
                })
            });
            
            const eventData = await eventResponse.json();
            
            if (!eventResponse.ok) {
                throw new Error(eventData.error?.message || 'ì´ë²¤íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
            
            // ì¸ê¸° í˜ì´ì§€ ë°ì´í„° ìš”ì²­
            const pagesResponse = await fetch(`https://analyticsdata.googleapis.com/v1beta/properties/${selectedPropertyId}:runReport`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dateRanges: [{
                        startDate: currentDateRange.startDate,
                        endDate: currentDateRange.endDate
                    }],
                    dimensions: [{ name: 'pagePath' }],
                    metrics: [{ name: 'screenPageViews' }],
                    orderBys: [{ metric: { metricName: 'screenPageViews' }, desc: true }],
                    limit: 10
                })
            });
            
            const pagesData = await pagesResponse.json();
            
            if (!pagesResponse.ok) {
                throw new Error(pagesData.error?.message || 'í˜ì´ì§€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
            
            // ì§€ì—­ë³„ ë°ì´í„° ìš”ì²­
            const geoResponse = await fetch(`https://analyticsdata.googleapis.com/v1beta/properties/${selectedPropertyId}:runReport`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dateRanges: [{
                        startDate: currentDateRange.startDate,
                        endDate: currentDateRange.endDate
                    }],
                    dimensions: [{ name: 'country' }],
                    metrics: [{ name: 'totalUsers' }, { name: 'sessions' }],
                    orderBys: [{ metric: { metricName: 'totalUsers' }, desc: true }],
                    limit: 10
                })
            });
            
            const geoData = await geoResponse.json();
            
            if (!geoResponse.ok) {
                throw new Error(geoData.error?.message || 'ì§€ì—­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
            
            displayReportData(metricsData, previousMetricsData, trendData, deviceData, browserData, channelData, eventData, pagesData, geoData);
            
        } catch (error) {
            throw error;
        }
    }

    // ì´ì „ ê¸°ê°„ ê³„ì‚° í•¨ìˆ˜
    function calculatePreviousPeriod() {
        const startDate = new Date(currentDateRange.startDate);
        const endDate = new Date(currentDateRange.endDate);
        const periodLength = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
        
        const previousEndDate = new Date(startDate);
        previousEndDate.setDate(previousEndDate.getDate() - 1);
        
        const previousStartDate = new Date(previousEndDate);
        previousStartDate.setDate(previousStartDate.getDate() - periodLength + 1);
        
        return {
            startDate: previousStartDate.toISOString().split('T')[0],
            endDate: previousEndDate.toISOString().split('T')[0]
        };
    }

    // ë¦¬í¬íŠ¸ ë°ì´í„° í‘œì‹œ
    function displayReportData(metricsData, previousMetricsData, trendData, deviceData, browserData, channelData, eventData, pagesData, geoData) {
        try {
            console.log('ë¦¬í¬íŠ¸ ë°ì´í„° í‘œì‹œ ì‹œì‘');
            
            // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
            const lastUpdatedEl = document.getElementById('lastUpdated');
            if (lastUpdatedEl) {
                lastUpdatedEl.textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')}`;
            }
            
            // ì£¼ìš” ì§€í‘œ ì—…ë°ì´íŠ¸
            if (metricsData.rows && metricsData.rows.length > 0) {
                const metrics = metricsData.rows[0].metricValues;
                const previousMetrics = previousMetricsData.rows && previousMetricsData.rows.length > 0 ? 
                    previousMetricsData.rows[0].metricValues : null;
                
                // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶œë ¥
                console.log('GA4 Metrics Data:', {
                    totalUsers: metrics[0].value,
                    newUsers: metrics[1].value,
                    sessions: metrics[2].value,
                    engagementRate: metrics[3].value,
                    bounceRate: metrics[4].value,
                    screenPageViewsPerSession: metrics[5].value,
                    averageSessionDuration: metrics[6].value
                });
                
                updateMetricCard('totalUsers', parseInt(metrics[0].value || 0), previousMetrics ? parseInt(previousMetrics[0].value || 0) : null);
                updateMetricCard('newUsers', parseInt(metrics[1].value || 0), previousMetrics ? parseInt(previousMetrics[1].value || 0) : null);
                updateMetricCard('sessions', parseInt(metrics[2].value || 0), previousMetrics ? parseInt(previousMetrics[2].value || 0) : null);
                // screenPageViews ì²˜ë¦¬ (ì¡°íšŒìˆ˜)
                const screenPageViews = parseInt(metrics[6].value || 0);
                const prevScreenPageViews = previousMetrics ? parseInt(previousMetrics[6].value || 0) : null;
                
                updateMetricCard('screenPageViews', screenPageViews, prevScreenPageViews);
                updateMetricCard('bounceRate', Math.round(parseFloat(metrics[4].value || 0) * 100), previousMetrics ? Math.round(parseFloat(previousMetrics[4].value || 0) * 100) : null, '%');
                // screenPageViewsPerSession ê³„ì‚° (screenPageViews / sessions)
                const totalPageViews = parseFloat(metrics[6].value || 0);
                const totalSessions = parseFloat(metrics[2].value || 0);
                const pageViewsPerSession = totalSessions > 0 ? totalPageViews / totalSessions : 0;
                
                const prevTotalPageViews = previousMetrics ? parseFloat(previousMetrics[6].value || 0) : null;
                const prevTotalSessions = previousMetrics ? parseFloat(previousMetrics[2].value || 0) : null;
                const prevPageViewsPerSession = (prevTotalSessions && prevTotalSessions > 0) ? prevTotalPageViews / prevTotalSessions : null;
                
                console.log('PageViews per Session Calculation:', {
                    totalPageViews: totalPageViews,
                    totalSessions: totalSessions,
                    calculated: pageViewsPerSession,
                    previous: prevPageViewsPerSession
                });
                
                updateMetricCard('screenPageViewsPerSession', pageViewsPerSession.toFixed(2), prevPageViewsPerSession, '');
                
                // averageSessionDuration ì²˜ë¦¬
                const avgSessionDuration = parseFloat(metrics[7].value || 0);
                const prevAvgSessionDuration = previousMetrics ? parseFloat(previousMetrics[7].value || 0) : null;
                
                console.log('Average Session Duration:', {
                    current: avgSessionDuration,
                    previous: prevAvgSessionDuration,
                    rawValue: metrics[7].value,
                    formatted: formatDuration(avgSessionDuration)
                });
                
                updateMetricCard('averageSessionDuration', formatDuration(avgSessionDuration), prevAvgSessionDuration ? formatDuration(prevAvgSessionDuration) : null);
            } else {
                // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° 0ìœ¼ë¡œ í‘œì‹œ
                updateMetricCard('totalUsers', 0, null);
                updateMetricCard('newUsers', 0, null);
                updateMetricCard('sessions', 0, null);
                updateMetricCard('screenPageViews', 0, null);
                updateMetricCard('bounceRate', 0, null, '%');
                updateMetricCard('screenPageViewsPerSession', '0.00', null);
                updateMetricCard('averageSessionDuration', '0ë¶„ 0ì´ˆ', null);
            }
            
            // ì°¨íŠ¸ ìƒì„±
            createTrendChart(trendData);
            createDeviceChart(deviceData);
            createBrowserTable(browserData);
            createChannelChart(channelData);
            createEventTable(eventData);
            createTopPagesTable(pagesData);
            createGeoTable(geoData);
            generateInsights(metricsData, deviceData, channelData);
            
            console.log('ë¦¬í¬íŠ¸ ë°ì´í„° í‘œì‹œ ì™„ë£Œ');
            
        } catch (error) {
            console.error('ë°ì´í„° í‘œì‹œ ì¤‘ ì˜¤ë¥˜:', error);
            showError('ë°ì´í„°ë¥¼ í‘œì‹œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ì§€í‘œ ì¹´ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateMetricCard(metricId, currentValue, previousValue, suffix = '') {
        const valueEl = document.getElementById(metricId);
        const changeEl = document.getElementById(metricId + 'Change');
        
        if (valueEl) {
            if (typeof currentValue === 'number') {
                valueEl.textContent = currentValue.toLocaleString() + suffix;
            } else {
                valueEl.textContent = currentValue + suffix;
            }
        }
        
        if (changeEl && previousValue !== null) {
            // í‰ê·  ì„¸ì…˜ ì‹œê°„ì˜ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
            if (metricId === 'averageSessionDuration') {
                const currentSeconds = parseDurationToSeconds(currentValue);
                const previousSeconds = parseDurationToSeconds(previousValue);
                
                if (previousSeconds > 0) {
                    const changePercent = ((currentSeconds - previousSeconds) / previousSeconds) * 100;
                    const changeText = changePercent > 0 ? `+${changePercent.toFixed(1)}%` : `${changePercent.toFixed(1)}%`;
                    changeEl.textContent = changeText;
                    changeEl.className = `ga4-metric-change ${changePercent >= 0 ? 'positive' : 'negative'}`;
                } else {
                    changeEl.textContent = '-';
                    changeEl.className = 'ga4-metric-change';
                }
            } else if (typeof currentValue === 'number' && typeof previousValue === 'number' && previousValue !== 0) {
                const changePercent = ((currentValue - previousValue) / previousValue) * 100;
                const changeText = changePercent > 0 ? `+${changePercent.toFixed(1)}%` : `${changePercent.toFixed(1)}%`;
                changeEl.textContent = changeText;
                changeEl.className = `ga4-metric-change ${changePercent >= 0 ? 'positive' : 'negative'}`;
            } else if (typeof currentValue === 'string' && typeof previousValue === 'number' && previousValue !== 0) {
                // ë¬¸ìì—´ ê°’(ì˜ˆ: "0.53")ê³¼ ìˆ«ì ê°’ ë¹„êµ
                const currentNum = parseFloat(currentValue);
                if (!isNaN(currentNum)) {
                    const changePercent = ((currentNum - previousValue) / previousValue) * 100;
                    const changeText = changePercent > 0 ? `+${changePercent.toFixed(1)}%` : `${changePercent.toFixed(1)}%`;
                    changeEl.textContent = changeText;
                    changeEl.className = `ga4-metric-change ${changePercent >= 0 ? 'positive' : 'negative'}`;
                } else {
                    changeEl.textContent = '-';
                    changeEl.className = 'ga4-metric-change';
                }
            } else {
                changeEl.textContent = '-';
                changeEl.className = 'ga4-metric-change';
            }
        } else if (changeEl) {
            changeEl.textContent = '-';
            changeEl.className = 'ga4-metric-change';
        }
    }

    // ì‹œê°„ í˜•ì‹ì„ ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    function parseDurationToSeconds(durationStr) {
        if (typeof durationStr === 'string' && durationStr.includes('ë¶„')) {
            const parts = durationStr.split('ë¶„');
            const minutes = parseInt(parts[0]) || 0;
            const seconds = parseInt(parts[1].replace('ì´ˆ', '')) || 0;
            return minutes * 60 + seconds;
        }
        return 0;
    }

    // ì‹œê°„ í¬ë§· í•¨ìˆ˜
    function formatDuration(seconds) {
        if (isNaN(seconds) || seconds === null || seconds === undefined) {
            return '0ë¶„ 0ì´ˆ';
        }
        
        const totalSeconds = Math.floor(parseFloat(seconds));
        const minutes = Math.floor(totalSeconds / 60);
        const remainingSeconds = totalSeconds % 60;
        
        // 0ì´ˆì¸ ê²½ìš°ì—ë„ ìµœì†Œ 1ì´ˆë¡œ í‘œì‹œ
        if (totalSeconds === 0) {
            return '0ë¶„ 1ì´ˆ';
        }
        
        return `${minutes}ë¶„ ${remainingSeconds}ì´ˆ`;
    }

    // ì¼ë³„ ì¶”ì´ ì°¨íŠ¸ ìƒì„± (ì‚¬ìš©ì + ì„¸ì…˜)
    function createTrendChart(trendData) {
        const ctx = document.getElementById('trendChart');
        if (!ctx) return;
        
        // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆë‹¤ë©´ ì œê±°
        if (window.ga4TrendChartInstance) {
            window.ga4TrendChartInstance.destroy();
        }
        
        let chartData = [];
        
        if (trendData.rows && trendData.rows.length > 0) {
            chartData = trendData.rows.map(row => ({
                date: row.dimensionValues[0].value,
                users: parseInt(row.metricValues[0].value || 0),
                sessions: parseInt(row.metricValues[1].value || 0)
            }));
            
            // ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬
            chartData.sort((a, b) => {
                const dateA = new Date(a.date.length === 8 ? 
                    `${a.date.substring(0,4)}-${a.date.substring(4,6)}-${a.date.substring(6,8)}` : a.date);
                const dateB = new Date(b.date.length === 8 ? 
                    `${b.date.substring(0,4)}-${b.date.substring(4,6)}-${b.date.substring(6,8)}` : b.date);
                return dateA - dateB;
            });
        } else {
            // ê¸°ë³¸ ë°ì´í„°
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                chartData.push({
                    date: date.toISOString().split('T')[0],
                    users: 0,
                    sessions: 0
                });
            }
        }
        
        window.ga4TrendChartInstance = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: chartData.map(item => {
                    // GA4 APIì—ì„œ ë°›ì€ ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬ (YYYYMMDD ë˜ëŠ” YYYY-MM-DD)
                    let dateStr = item.date;
                    if (dateStr.length === 8) {
                        // YYYYMMDD í˜•ì‹ì¸ ê²½ìš°
                        const year = dateStr.substring(0, 4);
                        const month = dateStr.substring(4, 6);
                        const day = dateStr.substring(6, 8);
                        return `${parseInt(month)}/${parseInt(day)}`;
                    } else {
                        // YYYY-MM-DD í˜•ì‹ì¸ ê²½ìš°
                        const date = new Date(dateStr);
                        return (date.getMonth() + 1) + '/' + date.getDate();
                    }
                }),
                datasets: [{
                    label: 'ì‚¬ìš©ì',
                    data: chartData.map(item => item.users),
                    borderColor: '#4285f4',
                    backgroundColor: 'rgba(66, 133, 244, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointBackgroundColor: '#4285f4',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6
                }, {
                    label: 'ì„¸ì…˜',
                    data: chartData.map(item => item.sessions),
                    borderColor: '#34a853',
                    backgroundColor: 'rgba(52, 168, 83, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointBackgroundColor: '#34a853',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    }
                },
                elements: {
                    point: {
                        hoverRadius: 8
                    }
                }
            }
        });
    }

    // ë””ë°”ì´ìŠ¤ë³„ ì°¨íŠ¸ ìƒì„±
    function createDeviceChart(deviceData) {
        const ctx = document.getElementById('deviceChart');
        if (!ctx) return;
        
        // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆë‹¤ë©´ ì œê±°
        if (window.ga4DeviceChartInstance) {
            window.ga4DeviceChartInstance.destroy();
        }
        
        let chartData = [];
        
        if (deviceData.rows && deviceData.rows.length > 0) {
            chartData = deviceData.rows.map(row => ({
                device: row.dimensionValues[0].value,
                users: parseInt(row.metricValues[0].value || 0),
                sessions: parseInt(row.metricValues[1].value || 0)
            }));
        } else {
            // ê¸°ë³¸ ë°ì´í„°
            chartData = [
                { device: 'desktop', users: 0, sessions: 0 },
                { device: 'mobile', users: 0, sessions: 0 },
                { device: 'tablet', users: 0, sessions: 0 }
            ];
        }
        
        // ë””ë°”ì´ìŠ¤ëª… í•œêµ­ì–´ë¡œ ë³€í™˜
        const deviceNames = {
            'desktop': 'ë°ìŠ¤í¬í†±',
            'mobile': 'ëª¨ë°”ì¼',
            'tablet': 'íƒœë¸”ë¦¿'
        };
        
        // ì´ ì‚¬ìš©ì ìˆ˜ ê³„ì‚°
        const totalUsers = chartData.reduce((sum, item) => sum + item.users, 0);
        
        window.ga4DeviceChartInstance = new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: chartData.map(item => {
                    const percentage = totalUsers > 0 ? ((item.users / totalUsers) * 100).toFixed(1) : 0;
                    return `${deviceNames[item.device] || item.device} (${percentage}%)`;
                }),
                datasets: [{
                    data: chartData.map(item => item.users),
                    backgroundColor: ['#4285f4', '#34a853', '#fbbc05'],
                    borderWidth: 0,
                    cutout: '60%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const percentage = totalUsers > 0 ? ((value / totalUsers) * 100).toFixed(1) : 0;
                                return `${label}: ${value.toLocaleString()}ëª… (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // ë¸Œë¼ìš°ì €ë³„ í…Œì´ë¸” ìƒì„±
    function createBrowserTable(browserData) {
        const tbody = document.getElementById('browserTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (browserData.rows && browserData.rows.length > 0) {
            const totalSessions = browserData.rows.reduce((sum, row) => sum + parseInt(row.metricValues[1].value || 0), 0);
            
            browserData.rows.forEach((row, index) => {
                const browser = row.dimensionValues[0].value;
                const sessions = parseInt(row.metricValues[1].value || 0);
                const percentage = totalSessions > 0 ? ((sessions / totalSessions) * 100).toFixed(1) : 0;
                
                // ë¸Œë¼ìš°ì €ëª… ì •ë¦¬
                const browserNames = {
                    'Chrome': 'Chrome',
                    'Safari': 'Safari',
                    'Firefox': 'Firefox',
                    'Microsoft Edge': 'Edge',
                    'Edge': 'Edge',
                    'Internet Explorer': 'IE',
                    'Opera': 'Opera',
                    'Samsung Internet': 'Samsung',
                    'Whale Browser': 'Whale Browser',
                    'Other': 'ê¸°íƒ€'
                };
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${browserNames[browser] || browser}</td>
                    <td>${sessions.toLocaleString()}</td>
                    <td>${percentage}%</td>
                `;
                tbody.appendChild(tr);
            });
        } else {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="4" style="text-align: center; color: #666;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td>';
            tbody.appendChild(tr);
        }
    }

    // ìœ ì… ì±„ë„ ì°¨íŠ¸ ìƒì„±
    function createChannelChart(channelData) {
        const ctx = document.getElementById('channelChart');
        if (!ctx) return;
        
        // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆë‹¤ë©´ ì œê±°
        if (window.ga4ChannelChartInstance) {
            window.ga4ChannelChartInstance.destroy();
        }
        
        let chartData = [];
        
        if (channelData.rows && channelData.rows.length > 0) {
            chartData = channelData.rows.map(row => ({
                channel: row.dimensionValues[0].value,
                sessions: parseInt(row.metricValues[0].value || 0),
                users: parseInt(row.metricValues[1].value || 0)
            }));
        } else {
            // ê¸°ë³¸ ë°ì´í„°
            chartData = [
                { channel: 'Organic Search', sessions: 0, users: 0 },
                { channel: 'Direct', sessions: 0, users: 0 },
                { channel: 'Referral', sessions: 0, users: 0 }
            ];
        }
        
        // ì±„ë„ëª… í•œêµ­ì–´ë¡œ ë³€í™˜
        const channelNames = {
            'Organic Search': 'ìì—° ê²€ìƒ‰',
            'Direct': 'ì§ì ‘ ìœ ì…',
            'Referral': 'ì¶”ì²œ',
            'Organic Social': 'ìì—° ì†Œì…œ',
            'Paid Social': 'ìœ ë£Œ ì†Œì…œ',
            'Paid Search': 'ìœ ë£Œ ê²€ìƒ‰',
            'Email': 'ì´ë©”ì¼',
            'Display': 'ë””ìŠ¤í”Œë ˆì´',
            'Other': 'ê¸°íƒ€'
        };
        
        window.ga4ChannelChartInstance = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: chartData.map(item => channelNames[item.channel] || item.channel),
                datasets: [{
                    label: 'ì„¸ì…˜ ìˆ˜',
                    data: chartData.map(item => item.sessions),
                    backgroundColor: '#4285f4',
                    borderColor: '#4285f4',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    }
                }
            }
        });
    }

    // ì£¼ìš” ì´ë²¤íŠ¸ í…Œì´ë¸” ìƒì„±
    function createEventTable(eventData) {
        const tbody = document.getElementById('eventTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (eventData.rows && eventData.rows.length > 0) {
            eventData.rows.forEach((row, index) => {
                const eventName = row.dimensionValues[0].value;
                const eventCount = parseInt(row.metricValues[0].value || 0);
                
                // ì´ë²¤íŠ¸ëª… í•œêµ­ì–´ë¡œ ë³€í™˜
                const eventNames = {
                    'page_view': 'page_view',
                    'scroll': 'scroll',
                    'click': 'click',
                    'session_start': 'session_start',
                    'first_visit': 'first_visit',
                    'user_engagement': 'user_engagement',
                    'file_download': 'file_download',
                    'video_start': 'video_start',
                    'video_complete': 'video_complete',
                    'form_start': 'form_start',
                    'form_submit': 'form_submit',
                    'purchase': 'purchase',
                    'add_to_cart': 'add_to_cart',
                    'view_item': 'view_item',
                    'search': 'search',
                    'login': 'login',
                    'sign_up': 'sign_up'
                };
                
                // ì´ë²¤íŠ¸ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
                const getEventCategory = (eventName) => {
                    const basicEvents = ['page_view', 'session_start', 'first_visit', 'user_engagement'];
                    const conversionEvents = ['purchase', 'add_to_cart', 'form_submit', 'sign_up', 'login'];
                    
                    if (basicEvents.includes(eventName)) {
                        return { text: 'ê¸°ë³¸ ì´ë²¤íŠ¸', class: 'basic-event' };
                    } else if (conversionEvents.includes(eventName)) {
                        return { text: 'ì „í™˜', class: 'conversion-event' };
                    } else {
                        return { text: 'ì»¤ìŠ¤í…€', class: 'custom-event' };
                    }
                };
                
                const category = getEventCategory(eventName);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td title="${eventNames[eventName] || eventName}">${eventNames[eventName] || eventName}</td>
                    <td>${eventCount.toLocaleString()}</td>
                    <td><span class="event-category-tag ${category.class}">${category.text}</span></td>
                `;
                tbody.appendChild(tr);
            });
        } else {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="4" style="text-align: center; color: #666;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td>';
            tbody.appendChild(tr);
        }
    }

    // ì¸ê¸° í˜ì´ì§€ í…Œì´ë¸” ìƒì„±
    function createTopPagesTable(pagesData) {
        const tbody = document.getElementById('topPagesTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (pagesData.rows && pagesData.rows.length > 0) {
            const totalPageViews = pagesData.rows.reduce((sum, row) => sum + parseInt(row.metricValues[0].value || 0), 0);
            
            pagesData.rows.forEach((row, index) => {
                const pagePath = row.dimensionValues[0].value;
                const pageViews = parseInt(row.metricValues[0].value || 0);
                const percentage = totalPageViews > 0 ? ((pageViews / totalPageViews) * 100).toFixed(1) : 0;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td title="${pagePath}">${pagePath.length > 50 ? pagePath.substring(0, 50) + '...' : pagePath}</td>
                    <td>${pageViews.toLocaleString()}</td>
                    <td>${percentage}%</td>
                `;
                tbody.appendChild(tr);
            });
        } else {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="4" style="text-align: center; color: #666;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td>';
            tbody.appendChild(tr);
        }
    }

    // ì§€ì—­ë³„ í…Œì´ë¸” ìƒì„±
    function createGeoTable(geoData) {
        const tbody = document.getElementById('geoTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (geoData.rows && geoData.rows.length > 0) {
            const totalUsers = geoData.rows.reduce((sum, row) => sum + parseInt(row.metricValues[0].value || 0), 0);
            
            geoData.rows.forEach((row, index) => {
                const country = row.dimensionValues[0].value;
                const users = parseInt(row.metricValues[0].value || 0);
                const sessions = parseInt(row.metricValues[1].value || 0);
                const percentage = totalUsers > 0 ? ((users / totalUsers) * 100).toFixed(1) : 0;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${country}</td>
                    <td>${users.toLocaleString()}</td>
                    <td>${percentage}%</td>
                `;
                tbody.appendChild(tr);
            });
        } else {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="4" style="text-align: center; color: #666;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td>';
            tbody.appendChild(tr);
        }
    }

    // ì¢…í•© ë¶„ì„ ë° ê¶Œì¥ì‚¬í•­ ìƒì„±
    function generateInsights(metricsData, deviceData, channelData) {
        const strengthsList = document.getElementById('strengthsList');
        const improvementsList = document.getElementById('improvementsList');
        const recommendationsList = document.getElementById('recommendationsList');
        
        if (!strengthsList || !improvementsList || !recommendationsList) return;
        
        const insights = analyzeData(metricsData, deviceData, channelData);
        
        strengthsList.innerHTML = insights.strengths.map(strength => `<li>${strength}</li>`).join('');
        improvementsList.innerHTML = insights.improvements.map(improvement => `<li>${improvement}</li>`).join('');
        recommendationsList.innerHTML = insights.recommendations.map(recommendation => `<li>${recommendation}</li>`).join('');
    }

    // ë°ì´í„° ë¶„ì„ í•¨ìˆ˜
    function analyzeData(metricsData, deviceData, channelData) {
        const insights = {
            strengths: [],
            improvements: [],
            recommendations: []
        };
        
        if (!metricsData.rows || metricsData.rows.length === 0) {
            insights.strengths.push('ë°ì´í„°ë¥¼ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            insights.improvements.push('GA4 ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤');
            insights.recommendations.push('GA4 ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”');
            return insights;
        }
        
        const metrics = metricsData.rows[0].metricValues;
        const totalUsers = parseInt(metrics[0].value || 0);
        const newUsers = parseInt(metrics[1].value || 0);
        const sessions = parseInt(metrics[2].value || 0);
        const screenPageViews = parseInt(metrics[6].value || 0);
        const bounceRate = parseFloat(metrics[4].value || 0) * 100;
        const avgSessionDuration = parseFloat(metrics[7].value || 0);
        
        // ê°•ì  ë¶„ì„
        if (screenPageViews > 1000) {
            insights.strengths.push(`ë†’ì€ ì¡°íšŒìˆ˜ (${screenPageViews.toLocaleString()}íšŒ) - ì½˜í…ì¸ ê°€ ì‚¬ìš©ìë“¤ì—ê²Œ ê´€ì‹¬ì„ ë°›ê³  ìˆìŠµë‹ˆë‹¤`);
        }
        if (bounceRate < 50) {
            insights.strengths.push(`ë‚®ì€ ì´íƒˆë¥  (${bounceRate.toFixed(1)}%) - ì‚¬ìš©ìë“¤ì´ ì—¬ëŸ¬ í˜ì´ì§€ë¥¼ íƒìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤`);
        }
        if (avgSessionDuration > 60) {
            insights.strengths.push(`ê¸´ í‰ê·  ì„¸ì…˜ ì‹œê°„ (${formatDuration(avgSessionDuration)}) - ì‚¬ìš©ìë“¤ì´ ì¶©ë¶„í•œ ì‹œê°„ì„ íˆ¬ìí•˜ê³  ìˆìŠµë‹ˆë‹¤`);
        }
        
        // ê°œì„  í•„ìš” ì˜ì—­ ë¶„ì„
        if (screenPageViews < 100) {
            insights.improvements.push(`ë‚®ì€ ì¡°íšŒìˆ˜ (${screenPageViews.toLocaleString()}íšŒ) - ì½˜í…ì¸  í’ˆì§ˆ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤`);
        }
        if (bounceRate > 70) {
            insights.improvements.push(`ë†’ì€ ì´íƒˆë¥  (${bounceRate.toFixed(1)}%) - ì²« í˜ì´ì§€ì—ì„œ ì‚¬ìš©ìë¥¼ ìœ ì§€í•˜ëŠ” ì „ëµì´ í•„ìš”í•©ë‹ˆë‹¤`);
        }
        if (avgSessionDuration < 30) {
            insights.improvements.push(`ì§§ì€ í‰ê·  ì„¸ì…˜ ì‹œê°„ (${formatDuration(avgSessionDuration)}) - ì‚¬ìš©ì ê²½í—˜ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤`);
        }
        
        // ê¶Œì¥ì‚¬í•­
        if (screenPageViews < 500) {
            insights.recommendations.push('ì½˜í…ì¸  í’ˆì§ˆì„ ë†’ì´ê³  ì‚¬ìš©ì ì°¸ì—¬ë¥¼ ìœ ë„í•˜ëŠ” ìš”ì†Œë¥¼ ì¶”ê°€í•˜ì„¸ìš”');
        }
        if (bounceRate > 60) {
            insights.recommendations.push('í˜ì´ì§€ ë¡œë”© ì†ë„ë¥¼ ê°œì„ í•˜ê³  ì²« í™”ë©´ì˜ ê°€ì¹˜ë¥¼ ëª…í™•íˆ ì „ë‹¬í•˜ì„¸ìš”');
        }
        if (totalUsers < 100) {
            insights.recommendations.push('SEO ìµœì í™”ì™€ ë§ˆì¼€íŒ… í™œë™ì„ í†µí•´ íŠ¸ë˜í”½ì„ ëŠ˜ë¦¬ì„¸ìš”');
        }
        
        // ê¸°ë³¸ ë©”ì‹œì§€ê°€ ì—†ëŠ” ê²½ìš°
        if (insights.strengths.length === 0) {
            insights.strengths.push('ë°ì´í„° ë¶„ì„ì„ í†µí•´ ê°•ì ì„ íŒŒì•…í•˜ê³  ìˆìŠµë‹ˆë‹¤');
        }
        if (insights.improvements.length === 0) {
            insights.improvements.push('í˜„ì¬ ë°ì´í„°ë¡œëŠ” íŠ¹ë³„í•œ ê°œì„ ì ì´ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤');
        }
        if (insights.recommendations.length === 0) {
            insights.recommendations.push('ì§€ì†ì ì¸ ëª¨ë‹ˆí„°ë§ì„ í†µí•´ ì„±ê³¼ë¥¼ ì¶”ì í•˜ì„¸ìš”');
        }
        
        return insights;
    }

    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    window.handleLogout = function() {
        console.log('ë¡œê·¸ì•„ì›ƒ ì‹œì‘');
        
        // í† í° ë° ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™”
        if (accessToken) {
            try {
                google.accounts.oauth2.revoke(accessToken, () => {
                    console.log('í† í°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                });
            } catch (error) {
                console.error('í† í° í•´ì œ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }
        
        accessToken = null;
        currentUser = null;
        selectedPropertyId = null;
        
        // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì œê±°
        if (window.ga4TrendChartInstance) {
            window.ga4TrendChartInstance.destroy();
            window.ga4TrendChartInstance = null;
        }
        if (window.ga4DeviceChartInstance) {
            window.ga4DeviceChartInstance.destroy();
            window.ga4DeviceChartInstance = null;
        }
        if (window.ga4ChannelChartInstance) {
            window.ga4ChannelChartInstance.destroy();
            window.ga4ChannelChartInstance = null;
        }
        
        // UI ì´ˆê¸°í™”
        const userInfo = document.getElementById('userInfo');
        const accountSelector = document.getElementById('accountSelector');
        const dashboard = document.getElementById('dashboard');
        const authSection = document.getElementById('authSection');
        const accountSelect = document.getElementById('accountSelect');
        const propertySelect = document.getElementById('propertySelect');
        const loadReportBtn = document.getElementById('loadReportBtn');
        
        if (userInfo) userInfo.style.display = 'none';
        if (accountSelector) accountSelector.style.display = 'none';
        if (dashboard) dashboard.style.display = 'none';
        if (authSection) authSection.style.display = 'block';
        
        // ì„ íƒ ë°•ìŠ¤ ì´ˆê¸°í™”
        if (accountSelect) accountSelect.innerHTML = '<option value="">ê³„ì •ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        if (propertySelect) propertySelect.innerHTML = '<option value="">ë¨¼ì € ê³„ì •ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        if (loadReportBtn) loadReportBtn.disabled = true;
    };

    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        if (errorDiv && message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            console.error('Error:', message);
        } else if (errorDiv) {
            errorDiv.style.display = 'none';
        }
    }

    // ì´ˆê¸°í™” í•¨ìˆ˜
    function initGA4Dashboard() {
        console.log('GA4 Dashboard ì´ˆê¸°í™” ì‹œì‘');
        updateStatus('Google API ë¡œë”© ì¤‘...');
        
        // ì´ˆê¸° ë‚ ì§œ ë²”ìœ„ ì„¤ì •
        initializeDateRange();
        
        // Google API ìŠ¤í¬ë¦½íŠ¸ ë™ì  ë¡œë“œ
        const gapiScript = document.createElement('script');
        gapiScript.src = 'https://apis.google.com/js/api.js';
        gapiScript.onload = window.ga4GapiLoaded;
        gapiScript.onerror = () => {
            updateStatus('Google API ë¡œë“œ ì‹¤íŒ¨');
            showError('Google APIë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        };
        document.head.appendChild(gapiScript);
        
        const gsiScript = document.createElement('script');
        gsiScript.src = 'https://accounts.google.com/gsi/client';
        gsiScript.onload = window.ga4GsiLoaded;
        gsiScript.onerror = () => {
            updateStatus('Google Sign-In ë¡œë“œ ì‹¤íŒ¨');
            showError('Google Sign-Inì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        };
        document.head.appendChild(gsiScript);
    }

    // DOMì´ ë¡œë“œë˜ë©´ ì´ˆê¸°í™”
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initGA4Dashboard);
    } else {
        initGA4Dashboard();
    }

})();
</script>


    <script src="js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            fetch('includes/header.html').then(r=>r.text()).then(h=>{ document.getElementById('header').innerHTML=h; });
            fetch('includes/sidebar.html').then(r=>r.text()).then(s=>{ document.getElementById('sidebar').innerHTML=s; });
            fetch('includes/footer.html').then(r=>r.text()).then(f=>{ document.getElementById('footer').innerHTML=f; });
            fetch('includes/chatbot.html').then(r=>r.text()).then(b=>{ document.getElementById('chatbot').innerHTML=b; });
        });
    </script>
</body>
</html>


